name: Docker Image CI
on:
  push:
    tags:
      - v*
    branches:
      - beta

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24.x"
      - name: Install dependencies
        run: yarn
      - name: Run tests
        run: yarn test

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24.x"
      - name: Install dependencies
        run: yarn
      - name: Run linting
        run: yarn lint

  docker:
    runs-on: ubuntu-latest
    needs: [test, lint]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set Docker tags
        id: docker_tags
        run: |
          if [[ "${{ github.ref }}" == refs/heads/beta ]]; then
            # For beta branch - include timestamp
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            echo "TAGS=ghcr.io/nicolaschan/bell:beta-${TIMESTAMP},ghcr.io/nicolaschan/bell:beta" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # For version tags (v*)
            VERSION=${GITHUB_REF#refs/tags/}
            echo "TAGS=ghcr.io/nicolaschan/bell:${VERSION},ghcr.io/nicolaschan/bell:latest" >> $GITHUB_OUTPUT
          fi
      - name: Run Build
        run: |
          IFS=',' read -ra TAGS_ARRAY <<< "${{ steps.docker_tags.outputs.TAGS }}"
          TAG_ARGS=""
          for tag in "${TAGS_ARRAY[@]}"; do
            TAG_ARGS="$TAG_ARGS --tag $tag"
          done
          docker build . --push $TAG_ARGS
