name: Docker Image CI
on:
  push:
    tags:
      - v*
    branches:
      - beta

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24.x"
      - name: Install dependencies
        run: yarn
      - name: Run tests
        run: yarn test

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24.x"
      - name: Install dependencies
        run: yarn
      - name: Run linting
        run: yarn lint

  docker:
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - uses: actions/checkout@v3
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
        with:
          platforms: all
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
        with:
          version: latest
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}
      - name: Set Docker tags
        id: docker_tags
        run: |
          if [[ "${{ github.ref }}" == refs/heads/beta ]]; then
            # For beta branch - include timestamp
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            echo "TAGS=ghcr.io/nicolaschan/bell:beta-${TIMESTAMP},ghcr.io/nicolaschan/bell:beta" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # For version tags (v*)
            VERSION=${GITHUB_REF#refs/tags/}
            echo "TAGS=ghcr.io/nicolaschan/bell:${VERSION},ghcr.io/nicolaschan/bell:latest" >> $GITHUB_OUTPUT
          fi

      - name: Run Buildx
        run: |
          IFS=',' read -ra TAGS_ARRAY <<< "${{ steps.docker_tags.outputs.TAGS }}"
          TAG_ARGS=""
          for tag in "${TAGS_ARRAY[@]}"; do
            TAG_ARGS="$TAG_ARGS --tag $tag"
          done

          docker buildx build \
          --pull \
          --push \
          --platform linux/amd64 \
          $TAG_ARGS .
